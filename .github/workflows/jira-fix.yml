name: Fix Jira Issue

on:
  repository_dispatch:
    types: [jira-fix]

jobs:
  fix:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            You have been assigned the following Jira issue to work on.

            ## Jira Issue
            - **Key**: ${{ github.event.client_payload.issue_key }}
            - **Summary**: ${{ github.event.client_payload.summary }}
            - **Description**: ${{ github.event.client_payload.description }}
            - **Type**: ${{ github.event.client_payload.issue_type }}
            - **Priority**: ${{ github.event.client_payload.priority }}

            ## Instructions
            1. Read the issue carefully and understand what is being asked
            2. Explore the repository to understand the codebase structure and conventions
            3. Implement the changes needed to resolve the issue
            4. Write or update tests to cover your changes. Follow the existing test patterns in the repo.
            5. Run `npm ci && npm test` to verify nothing is broken
            6. Also run tests in the eslint-plugin and vscode-extension subdirectories
            7. Create a PR with the title: "${{ github.event.client_payload.issue_key }}: ${{ github.event.client_payload.summary }}"
            8. In the PR description, reference the Jira issue key and explain what was changed and why
